{"version":3,"file":"mse.min.js","sources":["../../src/mp4/log.js","../../src/common/utils.js","../../src/mp4/index.js"],"sourcesContent":["var $vlog = document.getElementById('vlog');\nvar $video = document.getElementById('video');\n\nvar loadstart = 0,\n  loadedmetadata = 0;\nvar eventTester = function(e) {\n  $video.addEventListener(e, function(data) {\n    var t = (new Date()).getTime();\n    createvlog(t + ' ' + e);\n    if (e == 'loadedmetadata') {\n      loadedmetadata = t;\n      createvlog((loadedmetadata - loadstart) + 'ms');\n    } else if (e == 'loadstart') {\n      loadstart = t;\n    } else {\n      if ($video.buffered.length > 0) createvlog('buffered' + $video.buffered.start(0) + ',' + $video.buffered.end(0))\n    }\n  }, false);\n}\n\nfunction createvlog(text) {\n  var p = document.createElement('p');\n  p.innerHTML = text;\n  $vlog.appendChild(p);\n}\n\neventTester(\"loadstart\"); //客户端开始请求数据\neventTester(\"progress\"); //客户端正在请求数据\neventTester(\"suspend\"); //延迟下载\neventTester(\"abort\"); //客户端主动终止下载（不是因为错误引起）\neventTester(\"loadstart\"); //客户端开始请求数据\neventTester(\"progress\"); //客户端正在请求数据\neventTester(\"suspend\"); //延迟下载\neventTester(\"abort\"); //客户端主动终止下载（不是因为错误引起），\neventTester(\"error\"); //请求数据时遇到错误\neventTester(\"stalled\"); //网速失速\neventTester(\"play\"); //play()和autoplay开始播放时触发\neventTester(\"pause\"); //pause()触发\neventTester(\"loadedmetadata\"); //成功获取资源长度\neventTester(\"loadeddata\"); //\neventTester(\"waiting\"); //等待数据，并非错误\neventTester(\"playing\"); //开始回放\neventTester(\"canplay\"); //可以播放，但中途可能因为加载而暂停\neventTester(\"canplaythrough\"); //可以播放，歌曲全部加载完毕\neventTester(\"seeking\"); //寻找中\neventTester(\"seeked\"); //寻找完毕\n// eventTester(\"timeupdate\"); //播放时间改变\neventTester(\"ended\"); //播放结束\neventTester(\"ratechange\"); //播放速率改变\neventTester(\"durationchange\"); //资源长度改变\neventTester(\"volumechange\"); //音量改变","function GET(url, callback) {\n  var xhr = new XMLHttpRequest();\n  xhr.open('GET', url);\n  xhr.responseType = 'arraybuffer';\n  xhr.onload = function(e) {\n    if (xhr.status != 200) {\n      console.warn('Unexpected status code ' + xhr.status + ' for ' + url);\n      return false;\n    }\n    callback(xhr.response);\n  };\n  xhr.send();\n}\n\nexport default {\n  GET\n}","import './log';\nimport utils from '../common/utils';\n\n\nvar baseUrl = 'https://bitdash-a.akamaihd.net/content/MI201109210084_1/video/720_2400000/dash';\nvar ms = new MediaSource();\nvar sourceBuffer;\nvar i = 0;\nvar numberOfChunks = 52;\nvar requesting = false;\nvar $video = document.getElementById('video');\nvar $log = document.getElementById('log');\n$video.src = window.URL.createObjectURL(ms);\nms.addEventListener('sourceopen', onMediaSourceOpen);\n\nfunction onMediaSourceOpen() {\n  createlog('media source open');\n}\n\nfunction load() {\n  createlog(`正在加载初始化信息...`);\n  utils.GET(`${baseUrl}/init.mp4`, function(videoChunk) {\n    sourceBuffer = ms.addSourceBuffer('video/mp4; codecs=\"avc1.4d401f\"');\n    if (videoChunk) {\n      sourceBuffer.appendBuffer(new Uint8Array(videoChunk));\n      setTimeout(function() {\n        createlog(`初始化信息成功！视频时长：${ms.duration}秒`);\n      }, 100);\n    }\n    // $video.play();\n    sourceBuffer.addEventListener('updateend', nextSegment);\n  });\n}\nwindow.load = load;\nwindow.loadmore = loadmore;\n\nfunction loadmore() {\n  if (requesting) {\n    createlog(`请勿重复请求`);\n    return;\n  }\n  requesting = true;\n  createlog(`正在请求片段${i}...`);\n  utils.GET(`${baseUrl}/segment_${i}.m4s`, function(videoChunk) {\n    if (videoChunk) {\n      sourceBuffer.appendBuffer(new Uint8Array(videoChunk));\n      i++;\n      requesting = false;\n    }\n  });\n}\n\nfunction nextSegment() {\n  if ($video.buffered.length > 0) createlog(`片段${i-1}请求成功, 缓冲到${$video.buffered.end(0)}秒`);\n  // GET('https://bitdash-a.akamaihd.net/content/MI201109210084_1/video/720_2400000/dash/segment_0.m4s', function(videoChunk) {\n  //   if (videoChunk) {\n  //     sourceBuffer.appendBuffer(new Uint8Array(videoChunk));\n  //   }\n  // });\n}\n\nfunction createlog(text) {\n  var p = document.createElement('p');\n  p.innerHTML = text;\n  $log.appendChild(p);\n}"],"names":["$video"],"mappings":"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"}